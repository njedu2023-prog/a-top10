<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A-Share TOP10</title>

  <!-- Markdown 渲染库（前端直接把 .md 转成 HTML） -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg:#ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb;
      --card:#f9fafb;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      margin:0; background:var(--bg); color:var(--fg);
    }
    .wrap{max-width: 980px; margin: 0 auto; padding: 24px 16px 60px;}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px;}
    h1{font-size:16px; margin:0; letter-spacing:.5px;}
    .nav{display:flex; gap:10px; align-items:center;}
    button{
      border:1px solid var(--line);
      background:#fff; color:var(--fg);
      padding:10px 12px; border-radius:10px;
      cursor:pointer; font-size:14px;
    }
    button:hover{background:var(--card);}
    .card{
      border:1px solid var(--line);
      background: var(--card);
      border-radius: 14px;
      padding: 16px;
      margin-top: 14px;
    }
    .card h2{margin:0 0 10px; font-size:16px;}
    .md{line-height:1.65;}
    .md h1,.md h2,.md h3{margin-top:18px;}
    .md table{border-collapse: collapse; width:100%; overflow:auto; display:block;}
    .md th,.md td{border:1px solid var(--line); padding:8px 10px; font-size:14px; white-space:nowrap;}
    .md blockquote{border-left:3px solid var(--line); margin:10px 0; padding:0 12px; color:var(--muted);}
    .hint{color:var(--muted); font-size:13px;}
    .err{color:#b91c1c; font-size:13px; white-space:pre-wrap;}
    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      margin: 14px 0 6px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .datebox{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px;}
    input[type="date"]{
      border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:14px;
      background:#fff;
    }

    /* 学习区 KPI + 表格 */
    .kpi{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      margin: 8px 0 12px;
    }
    .kpi strong{font-size:14px;}
    .kpi span{color:var(--muted); font-size:13px;}
    .tbl-wrap{overflow:auto;}
    table.simple{
      border-collapse: collapse; width:100%;
      background:#fff; border:1px solid var(--line);
      border-radius: 12px; overflow:hidden;
    }
    table.simple th, table.simple td{
      border-bottom:1px solid var(--line);
      padding:10px 12px; font-size:14px; white-space:nowrap;
      text-align:left;
    }
    table.simple th{background: var(--card); font-weight:600;}
    table.simple tr:last-child td{border-bottom:none;}
  </style>

  <script>
    // =========================
    // 常量
    // =========================
    const LOOKBACK_DAYS = 60;

    const STEP7_JSON_LATEST = "outputs/learning/step7_report_latest.json";
    const STEP7_MD_LATEST   = "outputs/learning/step7_report_latest.md";
    const STEP7_HIT_CSV     = "outputs/learning/step7_hit_rate_history.csv";

    // =========================
    // 基础工具
    // =========================
    function yyyymmdd(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}${m}${d}`;
    }
    function yyyy_mm_dd(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function toDateInputValue(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function fromDateInputValue(v){
      const [y,m,d] = v.split('-').map(x=>parseInt(x,10));
      return new Date(y, m-1, d);
    }
    function getQueryDate(){
      const p = new URLSearchParams(location.search);
      const d = p.get('d');
      if(d && /^\d{8}$/.test(d)){
        const y = parseInt(d.slice(0,4),10);
        const m = parseInt(d.slice(4,6),10);
        const dd = parseInt(d.slice(6,8),10);
        return new Date(y, m-1, dd);
      }
      return new Date();
    }
    function setQueryDate(date){
      const d = yyyymmdd(date);
      const url = new URL(location.href);
      url.searchParams.set('d', d);
      location.href = url.toString();
    }
    function mdPathFor(date){
      return `outputs/predict_top10_${yyyymmdd(date)}.md`;
    }

    async function fetchText(path){
      const res = await fetch(path, { cache: "no-store" });
      if(!res.ok) throw new Error(`${res.status} -> ${path}`);
      return await res.text();
    }
    async function fetchJson(path){
      const res = await fetch(path, { cache: "no-store" });
      if(!res.ok) throw new Error(`${res.status} -> ${path}`);
      return await res.json();
    }
    async function exists(path){
      const res = await fetch(path, { method: "GET", cache: "no-store" });
      return res.ok;
    }

    // =========================
    // 日报：定位最近可用日期
    // =========================
    async function findNearestExistingReportDate(startDate){
      for(let i=0; i<=LOOKBACK_DAYS; i++){
        const d = new Date(startDate);
        d.setDate(d.getDate() - i);
        const path = mdPathFor(d);
        const res = await fetch(path, { method: "GET", cache: "no-store" });
        if(res.ok) return d;
      }
      return null;
    }

    async function loadDailyReport(targetDate){
      const titleEl = document.getElementById('title');
      const reportEl = document.getElementById('report');
      const errEl = document.getElementById('report_err');
      const picker = document.getElementById('date_picker');
      const navHint = document.getElementById('nav_hint');

      errEl.textContent = "";
      reportEl.innerHTML = `<div class="hint">正在定位可用日报（最多回退 ${LOOKBACK_DAYS} 天）...</div>`;

      const useDate = await findNearestExistingReportDate(targetDate);
      if(!useDate){
        titleEl.textContent = `A-Share TOP10`;
        reportEl.innerHTML = "";
        errEl.textContent =
          `在 ${yyyymmdd(targetDate)} 往前 ${LOOKBACK_DAYS} 天内，都没有找到 outputs/predict_top10_YYYYMMDD.md。\n` +
          `请确认日报文件已提交到仓库 outputs/ 目录，并能通过 Pages 访问。`;
        return null;
      }

      picker.value = toDateInputValue(useDate);
      const targetStr = yyyymmdd(targetDate);
      const useStr = yyyymmdd(useDate);
      navHint.textContent = (useStr !== targetStr)
        ? `提示：你选择的 ${targetStr} 无日报，已自动回退到最近可用日报 ${useStr}`
        : `提示：URL 参数 d=YYYYMMDD 可直接跳转某日报告`;

      const niceDate = yyyy_mm_dd(useDate);
      titleEl.textContent = `A-Share TOP10 - ${niceDate}`;
      document.title = `A-Share TOP10 - ${niceDate}`;

      const path = mdPathFor(useDate);
      reportEl.innerHTML = `<div class="hint">正在加载：${path}</div>`;

      try{
        const md = await fetchText(path);

        // 去掉 md 第一行标题
        let md2 = md;
        const lines = md2.split(/\r?\n/);
        if (lines.length > 0 && lines[0].trim().startsWith('#')) {
          lines.shift();
          while (lines.length > 0 && lines[0].trim() === '') lines.shift();
          md2 = lines.join('\n');
        }
        reportEl.innerHTML = marked.parse(md2);
      }catch(e){
        reportEl.innerHTML = "";
        errEl.textContent = `读取日报失败：${e.message}`;
      }

      return useDate;
    }

    // =========================
    // 近10日表：渲染
    // =========================
    function formatRate(x){
      if(x === null || x === undefined || x === "") return "";
      const n = Number(x);
      if(Number.isFinite(n)){
        if(n <= 1) return `${Math.round(n*100)}%`;
        if(n <= 100) return `${Math.round(n)}%`;
      }
      return String(x);
    }

    function renderHit10Table(rows, sourceLabel){
      const box = document.getElementById('hit10');
      const title = document.getElementById('hit10_title');

      if(!rows || rows.length === 0){
        title.textContent = "近10日 Top10 命中率";
        box.innerHTML = `<div class="hint">未找到可渲染的近10日数据</div>`;
        return;
      }

      // ✅ 强制显示 10 条
      const top10 = rows.slice(0, 10);

      title.textContent = `近10日 Top10 命中率（${sourceLabel}）`;

      const html = [];
      html.push(`<div class="tbl-wrap"><table class="simple">`);
      html.push(`<thead><tr>
        <th>日期</th><th>命中数</th><th>命中率</th><th>当日涨停家数</th>
      </tr></thead><tbody>`);

      for(const r of top10){
        html.push(`<tr>
          <td>${r.date ?? ""}</td>
          <td>${r.hit ?? ""}</td>
          <td>${formatRate(r.rate)}</td>
          <td>${r.total ?? ""}</td>
        </tr>`);
      }

      html.push(`</tbody></table></div>`);
      box.innerHTML = html.join("");
    }

    // =========================
    // 方案A（最稳）：从 step7_hit_rate_history.csv 取最近10条
    // =========================
    function parseCsv(text){
      const lines = text.split(/\r?\n/).filter(x=>x.trim()!=="");
      if(lines.length < 2) return { header: [], rows: [] };

      const header = lines[0].split(",").map(s=>s.trim());
      const rows = [];

      for(let i=1; i<lines.length; i++){
        // 简化：假设没有复杂引号逗号（你这个 csv 一般不会有）
        const cols = lines[i].split(",").map(s=>s.trim());
        const obj = {};
        for(let j=0; j<header.length && j<cols.length; j++){
          obj[header[j]] = cols[j];
        }
        rows.push(obj);
      }
      return { header, rows };
    }

    function pickCsvCols(header){
      // 兼容常见列名
      const pick = (cands) => {
        for(const c of cands){
          const idx = header.findIndex(h=>h===c);
          if(idx>=0) return c;
        }
        return null;
      };

      return {
        date:  pick(["trade_date","date","d","day"]),
        hit:   pick(["hit","hits","hit_count","hit_num","correct","correct_count","top10_hit"]),
        rate:  pick(["hit_rate","rate","accuracy","hit_ratio"]),
        total: pick(["limit_up_total","limit_up_count","total_limit_up","total","market_limit_up"])
      };
    }

    function rowsFromCsv(parsed){
      const { header, rows } = parsed;
      const m = pickCsvCols(header);

      // 如果 date 都找不到，直接放弃
      if(!m.date) return [];

      const out = rows.map(r=>({
        date: r[m.date],
        hit:  m.hit ? r[m.hit] : "",
        rate: m.rate ? r[m.rate] : "",
        total: m.total ? r[m.total] : ""
      })).filter(x=>x.date);

      // 按日期倒序（YYYYMMDD 或 YYYY-MM-DD 都能排）
      out.sort((a,b)=> String(b.date).localeCompare(String(a.date)));
      return out;
    }

    // =========================
    // 方案B（兜底）：深度扫描 JSON，自动找“最像表格”的数组
    // =========================
    function normalizeJsonRow(r){
      if(!r || typeof r !== "object") return null;
      const date = r.date || r.trade_date || r.d || r.day || r.D || r.TRADE_DATE;
      const hit  = r.hit || r.hits || r.hit_count || r.hit_num || r.correct || r.correct_count || r.top10_hit || r.HIT;
      const rate = r.hit_rate || r.rate || r.accuracy || r.hit_ratio || r.HIT_RATE;
      const total = r.limit_up_total || r.limit_up_count || r.total_limit_up || r.total || r.market_limit_up || r.LIMIT_UP_TOTAL;

      if(date === undefined && hit === undefined && rate === undefined && total === undefined) return null;

      return { date, hit, rate, total };
    }

    function scoreArrayAsHitTable(arr){
      if(!Array.isArray(arr) || arr.length === 0) return -1;

      let score = 0;
      let valid = 0;

      for(let i=0; i<Math.min(arr.length, 30); i++){
        const n = normalizeJsonRow(arr[i]);
        if(!n) continue;
        valid++;
        if(n.date) score += 3;
        if(n.hit !== undefined && n.hit !== null && n.hit !== "") score += 2;
        if(n.rate !== undefined && n.rate !== null && n.rate !== "") score += 2;
        if(n.total !== undefined && n.total !== null && n.total !== "") score += 1;
      }

      // 要求至少有几行有效，否则视为不是表
      if(valid < 3) return -1;

      // 偏好长度>=10
      if(arr.length >= 10) score += 5;

      return score;
    }

    function deepFindBestHitArray(obj){
      let best = { score: -1, arr: null };

      const visit = (node, depth) => {
        if(depth > 10) return;
        if(Array.isArray(node)){
          const s = scoreArrayAsHitTable(node);
          if(s > best.score){
            best = { score: s, arr: node };
          }
          for(const x of node){
            if(x && typeof x === "object") visit(x, depth+1);
          }
          return;
        }
        if(node && typeof node === "object"){
          for(const k of Object.keys(node)){
            const v = node[k];
            if(v && (typeof v === "object")) visit(v, depth+1);
          }
        }
      };

      visit(obj, 0);
      return best.arr;
    }

    // =========================
    // 学习区：统一基准日 + 近10日表（csv优先）
    // =========================
    async function loadLearningStatus(useDate){
      const kpi = document.getElementById('learning_kpi');
      const err = document.getElementById('learning_err');
      const mdBox = document.getElementById('learning_md');

      err.textContent = "";
      mdBox.innerHTML = "";

      kpi.innerHTML = `
        <strong>当前查看基准日：${useDate ? yyyy_mm_dd(useDate) : "-"}</strong>
        <span>说明：learning 只有 latest 文件，所以近10日表为“最新近10日”；日期显示与日报基准日保持一致</span>
      `;

      // 1) 近10日表：优先 CSV
      try{
        if(await exists(STEP7_HIT_CSV)){
          const csvText = await fetchText(STEP7_HIT_CSV);
          const parsed = parseCsv(csvText);
          const rows = rowsFromCsv(parsed);
          renderHit10Table(rows, `来源：${STEP7_HIT_CSV}`);
        }else{
          // 2) 否则从 JSON 深度搜索
          const obj = await fetchJson(STEP7_JSON_LATEST);
          const bestArr = deepFindBestHitArray(obj);
          if(bestArr){
            const rows = bestArr
              .map(normalizeJsonRow)
              .filter(x=>x && x.date)
              .sort((a,b)=> String(b.date).localeCompare(String(a.date)));
            renderHit10Table(rows, `来源：${STEP7_JSON_LATEST}`);
          }else{
            renderHit10Table([], "无可用数据");
          }
        }
      }catch(e){
        document.getElementById('hit10').innerHTML = "";
        err.textContent = `近10日命中率表渲染失败：${e.message}`;
      }

      // 3) learning md（可选）
      try{
        if(await exists(STEP7_MD_LATEST)){
          const md = await fetchText(STEP7_MD_LATEST);
          mdBox.innerHTML = marked.parse(md);
        }
      }catch(_){
        mdBox.innerHTML = "";
      }
    }

    // =========================
    // 导航：跳过缺失日报
    // =========================
    async function jumpByDaysSkippingMissing(currentDate, delta){
      for(let i=1; i<=LOOKBACK_DAYS; i++){
        const d = new Date(currentDate);
        d.setDate(d.getDate() + delta * i);
        const path = mdPathFor(d);
        const res = await fetch(path, { method: "GET", cache: "no-store" });
        if(res.ok) return d;
      }
      return null;
    }

    function bindNav(initialDate){
      const picker = document.getElementById('date_picker');

      document.getElementById('btn_prev').onclick = async () => {
        const base = fromDateInputValue(picker.value);
        const next = await jumpByDaysSkippingMissing(base, -1);
        if(next) setQueryDate(next);
        else alert(`向前 ${LOOKBACK_DAYS} 天内没有找到更早的日报文件`);
      };

      document.getElementById('btn_next').onclick = async () => {
        const base = fromDateInputValue(picker.value);
        const next = await jumpByDaysSkippingMissing(base, +1);
        if(next) setQueryDate(next);
        else alert(`向后 ${LOOKBACK_DAYS} 天内没有找到更新的日报文件`);
      };

      picker.value = toDateInputValue(initialDate);
      picker.onchange = () => {
        const d = fromDateInputValue(picker.value);
        setQueryDate(d);
      };
    }

    window.onload = async () => {
      const date = getQueryDate();
      bindNav(date);

      const useDate = await loadDailyReport(date);
      await loadLearningStatus(useDate || date);
    };
  </script>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1 id="title">A-Share TOP10</h1>
      </div>
      <div class="nav">
        <button id="btn_prev">←</button>
        <button id="btn_next">→</button>
      </div>
    </header>

    <div class="topbar">
      <div class="datebox">
        <span>选择日期：</span>
        <input id="date_picker" type="date" />
      </div>
      <div id="nav_hint" class="hint">提示：URL 参数 d=YYYYMMDD 可直接跳转某日报告</div>
    </div>

    <div class="card">
      <div id="report_err" class="err"></div>
      <div id="report" class="md"></div>
    </div>

    <div class="card">
      <h2>学习状态</h2>

      <div id="learning_kpi" class="kpi"></div>

      <div id="learning_err" class="err"></div>

      <h3 id="hit10_title" style="margin:12px 0 8px; font-size:15px;">近10日 Top10 命中率</h3>
      <div id="hit10"></div>

      <div id="learning_md" class="md" style="margin-top:12px;"></div>
    </div>
  </div>
</body>
</html>
