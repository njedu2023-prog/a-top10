name: Run Top10 Engine (Auto Daily)

on:
  schedule:
    - cron: "30 1 * * *"  # UTC 01:30 = Asia/Shanghai 09:30
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: top10-daily
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Shanghai

      # ---- 你的数据仓库信息（方案二：只用 raw，不用 GitHub API）----
      DATA_GITHUB_USER: njedu2023-prog
      DATA_REPO: a-share-top3-data
      DATA_BRANCH: main

      # ---- 与 configs/default.yml 对齐（warehouse_root / repo_name / raw_dir）----
      WAREHOUSE_ROOT: _warehouse
      RAW_DIR: data/raw

      # ---- 需要下载的文件清单（按你数据仓库 data/raw/YYYY/YYYYMMDD/ 内实际文件名来）----
      FILES: "daily.csv daily_basic.csv limit_list_d.csv hot_boards.csv top_list.csv"

      # ---- 自动回溯天数（找最近一个有数据的交易日目录）----
      LOOKBACK_DAYS: "20"

      # ---- 用于探测数据是否存在的哨兵文件（建议选最稳定必有的）----
      PROBE_FILE: "daily.csv"

    steps:
      - name: Checkout engine repo (a-top10)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # 如果你项目用 pyproject/poetry/pdm，可按需替换安装方式

      - name: Resolve latest snapshot trade_date (auto) - scheme2(raw probe)
        id: resolve_date
        shell: bash
        run: |
          set -euo pipefail

          echo "TZ=$TZ"
          echo "LOOKBACK_DAYS=$LOOKBACK_DAYS"
          echo "PROBE_FILE=$PROBE_FILE"

          base_url="https://raw.githubusercontent.com/${DATA_GITHUB_USER}/${DATA_REPO}/${DATA_BRANCH}/${RAW_DIR}"
          echo "Base raw url: ${base_url}"

          found=""
          for i in $(seq 0 "${LOOKBACK_DAYS}"); do
            d=$(date -d "today - ${i} day" +%Y%m%d)
            yyyy=$(date -d "${d}" +%Y)

            probe_url="${base_url}/${yyyy}/${d}/${PROBE_FILE}"
            echo "Probing: ${probe_url}"

            # 仅用 HEAD 探测是否存在
            if curl -sI --max-time 10 "${probe_url}" | head -n 1 | grep -q "200"; then
              found="${d}"
              break
            fi
          done

          if [ -z "${found}" ]; then
            echo "❌ No available trade_date found in last ${LOOKBACK_DAYS} days."
            exit 1
          fi

          echo "✅ trade_date=${found}"
          echo "trade_date=${found}" >> $GITHUB_OUTPUT

      - name: Download snapshot files from data repo (raw)
        shell: bash
        run: |
          set -euo pipefail

          TRADE_DATE="${{ steps.resolve_date.outputs.trade_date }}"
          YYYY="${TRADE_DATE:0:4}"

          echo "Using TRADE_DATE=${TRADE_DATE}"

          # 目标目录：_warehouse/<repo>/data/raw/YYYY/YYYYMMDD/
          target_dir="${WAREHOUSE_ROOT}/${DATA_REPO}/${RAW_DIR}/${YYYY}/${TRADE_DATE}"
          mkdir -p "${target_dir}"

          base_url="https://raw.githubusercontent.com/${DATA_GITHUB_USER}/${DATA_REPO}/${DATA_BRANCH}/${RAW_DIR}/${YYYY}/${TRADE_DATE}"

          for f in ${FILES}; do
            url="${base_url}/${f}"
            echo "Downloading: ${url}"
            # -f: 非 200 直接失败；-L: 跟随跳转；--retry: 网络抖动重试
            curl -fL --retry 3 --retry-delay 1 --max-time 30 -o "${target_dir}/${f}" "${url}"
          done

          echo "✅ Download done → ${target_dir}"
          ls -lh "${target_dir}"

      - name: Run Top10 Pipeline
        shell: bash
        run: |
          set -euo pipefail
          TRADE_DATE="${{ steps.resolve_date.outputs.trade_date }}"
          echo "Running pipeline for trade_date=${TRADE_DATE}"

          # 你的入口是 a_top10/main.py（可用 -m 方式）
          python -m a_top10.main "configs/default.yml" "${TRADE_DATE}"

      - name: Verify outputs
        shell: bash
        run: |
          set -euo pipefail
          # 按 configs/default.yml: io.outputs_dir = outputs
          if [ ! -d "outputs" ]; then
            echo "❌ outputs/ not found"
            exit 1
          fi
          echo "✅ outputs exists"
          find outputs -maxdepth 3 -type f -print

      - name: Commit outputs back to repo
        shell: bash
        run: |
          set -euo pipefail

          TRADE_DATE="${{ steps.resolve_date.outputs.trade_date }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add outputs || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Auto: update outputs for ${TRADE_DATE}"
          git push
