name: Run Top10 Engine (Manual or Daily)

on:
  workflow_dispatch:
    inputs:
      trade_date:
        description: "交易日 YYYYMMDD（留空则自动）"
        required: false
        default: ""
  schedule:
    - cron: "22 7 * * 1-5"   # 每个交易日前早上运行（北京时间 15:22 ≈ 美西 23:22）

permissions:
  contents: write

concurrency:
  group: run-top10
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # -----------------------
      # 1) Checkout 主仓库
      # -----------------------
      - name: Checkout engine repo (a-top10)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GH_TOKEN }}

      # -----------------------
      # 2) 安装 Python
      # -----------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # -----------------------
      # 3) 安装依赖（包含 sklearn）
      # -----------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install scikit-learn   # ⭐⭐ 方案 A：只新增 sklearn ⭐⭐

      # -----------------------
      # 4) Checkout 数据仓库（快照数据）
      # -----------------------
      - name: Checkout data warehouse (a-share-top3-data)
        uses: actions/checkout@v4
        with:
          repository: njedu2023-prog/a-share-top3-data
          path: _warehouse/a-share-top3-data
          fetch-depth: 1

      # -----------------------
      # 5) 运行 a-top10 Pipeline
      # -----------------------
      - name: Run Top10 Pipeline
        env:
          TRADE_DATE: ${{ github.event.inputs.trade_date }}
        run: |
          echo "Using TRADE_DATE=$TRADE_DATE"
          python -c "from a_top10.main import run_pipeline; run_pipeline('configs/default.yml')"

      # -----------------------
      # 6) 确保 outputs 存在
      # -----------------------
      - name: Ensure outputs exists
        run: |
          mkdir -p outputs
          ls -la outputs || true

      # -----------------------
      # 7) 上传 artifact（用于调试）
      # -----------------------
      - name: Upload outputs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: top10-outputs
          path: outputs/
          if-no-files-found: warn

      # -----------------------
      # 8) 自动提交 outputs 回主仓库
      # -----------------------
      - name: Commit outputs back to repo
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          git pull --rebase origin main || true
          git add outputs/

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "auto: update top10 outputs"
          git push origin HEAD:main || (sleep 3 && git push origin HEAD:main)
