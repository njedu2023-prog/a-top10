name: Run Top10 Engine (Auto Daily)

on:
  workflow_dispatch:

  schedule:
    # 北京时间 周一到周五 18:30（UTC 10:30）
    - cron: "30 10 * * 1-5"

permissions:
  contents: write

concurrency:
  group: top10-engine-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Shanghai
      PYTHONUTF8: "1"
      A_TOP10_TOKEN: ${{ secrets.A_TOP10_TOKEN }}

    steps:
      # =====================================================
      # Step0: Checkout 引擎仓库（只拉自己 repo）
      # =====================================================
      - name: Checkout engine repo (a-top10)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # =====================================================
      # Step1: Setup Python
      # =====================================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # =====================================================
      # Step2: Install dependencies
      # =====================================================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install requests

      # =====================================================
      # Step3: 自动解析最新可用交易日（以 top3-data 快照为准）
      # - 周末/节假日 => 自动回退到最近有快照的日期
      # =====================================================
      - name: Resolve latest snapshot trade_date (auto)
        run: |
          python - << 'PY'
          import os, re, datetime as dt
          import requests

          owner="njedu2023-prog"
          repo="a-share-top3-data"
          ref="main"

          token=os.getenv("A_TOP10_TOKEN","").strip() or os.getenv("GITHUB_TOKEN","").strip()
          headers={"Accept":"application/vnd.github+json","User-Agent":"a-top10-engine"}
          if token:
            headers["Authorization"]=f"token {token}"

          def list_dir(path):
            url=f"https://api.github.com/repos/{owner}/{repo}/contents/{path}?ref={ref}"
            r=requests.get(url, headers=headers, timeout=30)
            if r.status_code!=200:
              raise RuntimeError(f"list_dir failed: {path} HTTP {r.status_code} {r.text[:200]}")
            return r.json()

          today = dt.datetime.now().strftime("%Y%m%d")
          year = today[:4]

          # 先取当年 data/raw/YYYY 下的所有日期目录
          items = list_dir(f"data/raw/{year}")
          dates = []
          for it in items:
            if it.get("type")=="dir":
              name = it.get("name","")
              if re.fullmatch(r"\d{8}", name):
                if name <= today:
                  dates.append(name)

          if not dates:
            # 兜底：尝试去年（跨年第一天常见）
            prev_year = str(int(year)-1)
            items = list_dir(f"data/raw/{prev_year}")
            for it in items:
              if it.get("type")=="dir":
                name = it.get("name","")
                if re.fullmatch(r"\d{8}", name):
                  dates.append(name)
            if not dates:
              raise RuntimeError("找不到任何快照日期目录（data/raw/YYYY/YYYYMMDD）")

          trade_date = sorted(dates)[-1]
          print("Resolved TRADE_DATE =", trade_date)

          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as f:
            f.write(f"TRADE_DATE={trade_date}\n")
          PY

      # =====================================================
      # Step4: 下载快照文件（HTTP + GitHub API，不用 git）
      # 落地：data_repo/snapshots/TRADE_DATE/*.csv
      # =====================================================
      - name: Download snapshot files from top3-data (via GitHub API)
        run: |
          python - << 'PY'
          import os, json
          from pathlib import Path
          import requests

          trade_date = os.getenv("TRADE_DATE","").strip()
          if not trade_date:
            raise SystemExit("TRADE_DATE is empty")

          owner="njedu2023-prog"
          repo="a-share-top3-data"
          ref="main"
          year=trade_date[:4]
          remote_dir=f"data/raw/{year}/{trade_date}"

          token=os.getenv("A_TOP10_TOKEN","").strip() or os.getenv("GITHUB_TOKEN","").strip()
          headers={"Accept":"application/vnd.github+json","User-Agent":"a-top10-engine"}
          if token:
            headers["Authorization"]=f"token {token}"

          required=["daily.csv","daily_basic.csv","limit_list_d.csv","stock_basic.csv"]

          api=f"https://api.github.com/repos/{owner}/{repo}/contents/{remote_dir}?ref={ref}"
          r=requests.get(api, headers=headers, timeout=30)
          if r.status_code!=200:
            print("API:", api)
            print("HTTP:", r.status_code)
            print(r.text[:800])
            raise SystemExit("无法列出远端快照目录（可能是目录不存在 / token无权限）")

          items=r.json()
          if not isinstance(items, list):
            print(json.dumps(items, ensure_ascii=False)[:800])
            raise SystemExit("远端返回异常（不是文件列表）")

          name2url={it["name"]: it.get("download_url") for it in items if it.get("type")=="file"}
          missing=[f for f in required if f not in name2url]
          if missing:
            print("远端目录：", f"{owner}/{repo}/{remote_dir}")
            print("已发现文件(前30)：", sorted(list(name2url.keys()))[:30])
            raise SystemExit(f"远端快照缺少必需文件：{missing}")

          out_dir=Path("data_repo/snapshots")/trade_date
          out_dir.mkdir(parents=True, exist_ok=True)

          for f in required:
            p=out_dir/f
            if p.exists() and p.stat().st_size>0:
              continue
            rr=requests.get(name2url[f], headers=headers, timeout=60)
            if rr.status_code!=200:
              print("下载失败：", f, rr.status_code)
              print(rr.text[:300])
              raise SystemExit("download failed")
            p.write_bytes(rr.content)

          print("Snapshot ready at:", out_dir)
          for p in out_dir.glob("*.csv"):
            print(" -", p.name, p.stat().st_size)
          PY

      # =====================================================
      # Step5: Run Top10 Pipeline
      # 注意：你的主程序需要读取 data_repo/snapshots/TRADE_DATE 下文件
      # =====================================================
      - name: Run Top10 Pipeline
        run: |
          echo "TRADE_DATE=${TRADE_DATE}"
          python -m a_top10.run

      # =====================================================
      # Step6: Verify outputs
      # =====================================================
      - name: Verify outputs
        run: |
          ls -la outputs || true

      # =====================================================
      # Step7: Commit outputs back
      # =====================================================
      - name: Commit outputs back to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add outputs || true

          if git diff --cached --quiet; then
            echo "No output changes."
            exit 0
          fi

          git commit -m "auto: update top10 outputs"
          git push
