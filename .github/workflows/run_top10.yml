name: Run Top10 Engine (Manual or Daily)

on:
  workflow_dispatch:
    inputs:
      trade_date:
        description: "可选：指定交易日（YYYYMMDD），留空则自动推断"
        required: false
        default: ""

  schedule:
    # 北京时间 周一到周五 18:30（UTC 10:30）
    - cron: "30 10 * * 1-5"

permissions:
  contents: write

concurrency:
  group: top10-engine-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Shanghai
      PYTHONUTF8: "1"
      TRADE_DATE: ${{ inputs.trade_date }}

    steps:
      # =====================================================
      # Step0: Checkout 主引擎仓库（a-top10）
      # =====================================================
      - name: Checkout engine repo (a-top10)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # =====================================================
      # Step1: Setup Python
      # =====================================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # =====================================================
      # Step2: Install dependencies
      # =====================================================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # =====================================================
      # Step3: Checkout 数据仓库（a-share-top3-data）
      # ✅ 必须明确 token + path + ref
      # =====================================================
      - name: Checkout data warehouse (a-share-top3-data)
        uses: actions/checkout@v4
        with:
          repository: njedu2023-prog/a-share-top3-data
          ref: main
          token: ${{ secrets.A_TOP10_TOKEN }}
          path: _warehouse/a-share-top3-data
          fetch-depth: 1

      # =====================================================
      # Step4: ✅ 验货（最关键）
      # 直接打印快照目录是否存在，daily.csv 是否能找到
      # =====================================================
      - name: Verify warehouse files
        run: |
          echo "=================================================="
          echo "== VERIFY: warehouse root =="
          ls -la _warehouse || true

          echo "=================================================="
          echo "== VERIFY: a-share-top3-data root =="
          ls -la _warehouse/a-share-top3-data || true

          echo "=================================================="
          echo "== VERIFY: list data/raw (top) =="
          ls -la _warehouse/a-share-top3-data/data || true
          ls -la _warehouse/a-share-top3-data/data/raw || true

          echo "=================================================="
          echo "== VERIFY: find daily.csv (limit) =="
          find _warehouse/a-share-top3-data -name "daily.csv" | head -n 20 || true

          echo "=================================================="
          echo "== VERIFY: find limit_list_d.csv (limit) =="
          find _warehouse/a-share-top3-data -name "limit_list_d.csv" | head -n 20 || true

          echo "=================================================="
          echo "== DONE VERIFY =="
          echo "=================================================="

      # =====================================================
      # Step5: 打印 TRADE_DATE
      # =====================================================
      - name: Print trade_date context
        run: |
          echo "TRADE_DATE input = $TRADE_DATE"
          date

      # =====================================================
      # Step6: Run Top10 Pipeline
      # =====================================================
      - name: Run Top10 Pipeline
        run: |
          python -m a_top10.run

      # =====================================================
      # Step7: Ensure outputs exists
      # =====================================================
      - name: Ensure outputs exists
        run: |
          ls -la outputs || true

      # =====================================================
      # Step8: Commit outputs back
      # =====================================================
      - name: Commit outputs back to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add outputs || true

          if git diff --cached --quiet; then
            echo "No output changes."
            exit 0
          fi

          git commit -m "auto: update top10 outputs"
          git push
