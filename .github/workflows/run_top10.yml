name: Run Top10 Engine (Auto Daily)

on:
  schedule:
    - cron: "5 11 * * 1-5"
    - cron: "35 11 * * 1-5"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: top10-daily
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Shanghai
      PYTHONUTF8: "1"

      # ✅ 关键：secret 名为 A_TOP10_TOKEN，这里桥接到程序读取的 TUSHARE_TOKEN
      TUSHARE_TOKEN: ${{ secrets.A_TOP10_TOKEN }}

      # ---- 数据仓库信息（方案二：只用 raw，不用 GitHub API）----
      DATA_GITHUB_USER: njedu2023-prog
      DATA_REPO: a-share-top3-data
      DATA_BRANCH: main

      # ---- 与 configs/default.yml 对齐（warehouse_root / repo_name / raw_dir）----
      WAREHOUSE_ROOT: _warehouse
      RAW_DIR: data/raw

      # ---- 需要下载的文件清单（按 data/raw/YYYY/YYYYMMDD/ 内实际文件名）----
      FILES: "daily.csv daily_basic.csv limit_list_d.csv hot_boards.csv top_list.csv"

      # ---- 自动回溯天数（找最近一个有数据的交易日目录）----
      LOOKBACK_DAYS: "20"

      # ---- 用于探测数据是否存在的哨兵文件 ----
      PROBE_FILE: "daily.csv"

    steps:
      - name: Checkout engine repo (a-top10)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # ✅ pandas.DataFrame.to_markdown 依赖 tabulate
          pip install -U tabulate

      - name: Resolve latest snapshot trade_date (auto) - scheme2(raw probe)
        id: resolve_date
        shell: bash
        run: |
          set -euo pipefail

          echo "TZ=$TZ"
          echo "DATA_GITHUB_USER=$DATA_GITHUB_USER"
          echo "DATA_REPO=$DATA_REPO"
          echo "DATA_BRANCH=$DATA_BRANCH"
          echo "LOOKBACK_DAYS=$LOOKBACK_DAYS"
          echo "PROBE_FILE=$PROBE_FILE"

          today="$(date +%Y%m%d)"
          echo "today=$today"

          base="https://raw.githubusercontent.com/${DATA_GITHUB_USER}/${DATA_REPO}/${DATA_BRANCH}/${RAW_DIR}"

          found=""
          for i in $(seq 0 "$LOOKBACK_DAYS"); do
            d="$(date -d "${today} -${i} day" +%Y%m%d)"
            y="${d:0:4}"
            url="${base}/${y}/${d}/${PROBE_FILE}"

            code="$(curl -s -o /dev/null -w "%{http_code}" -I "$url" || true)"
            echo "[probe] ${d} => ${code} ${url}"

            if [ "$code" = "200" ]; then
              found="$d"
              break
            fi
          done

          if [ -z "$found" ]; then
            echo "ERROR: cannot find any snapshot within last ${LOOKBACK_DAYS} days."
            exit 2
          fi

          echo "Resolved trade_date=$found"
          echo "trade_date=$found" >> "$GITHUB_OUTPUT"

      - name: Download snapshot files to warehouse (raw)
        id: download
        shell: bash
        run: |
          set -euo pipefail

          trade_date="${{ steps.resolve_date.outputs.trade_date }}"
          year="${trade_date:0:4}"

          dest="${WAREHOUSE_ROOT}/${DATA_REPO}/${RAW_DIR}/${year}/${trade_date}"
          mkdir -p "$dest"

          base="https://raw.githubusercontent.com/${DATA_GITHUB_USER}/${DATA_REPO}/${DATA_BRANCH}/${RAW_DIR}/${year}/${trade_date}"

          echo "Downloading to: $dest"
          echo "Base URL: $base"
          echo "Files: $FILES"

          for f in $FILES; do
            url="${base}/${f}"
            out="${dest}/${f}"

            echo "[get] $url"
            curl -fL --retry 3 --retry-delay 1 -o "$out" "$url"
            ls -lh "$out"
          done

          echo "OK: downloaded snapshots for ${trade_date}"

      - name: Debug warehouse (list)
        shell: bash
        run: |
          set -euo pipefail
          echo "====== LIST _warehouse (top) ======"
          ls -la _warehouse || true
          echo "====== LIST snapshot dir ======"
          trade_date="${{ steps.resolve_date.outputs.trade_date }}"
          year="${trade_date:0:4}"
          ls -la "${WAREHOUSE_ROOT}/${DATA_REPO}/${RAW_DIR}/${year}/${trade_date}" || true

      - name: Run Top10 Engine
        shell: bash
        env:
          TRADE_DATE: ${{ steps.resolve_date.outputs.trade_date }}
        run: |
          set -euo pipefail
          echo "Running engine with TRADE_DATE=$TRADE_DATE"
          if [ -f "run.py" ]; then
            python run.py && python -m a_top10.steps.step7_self_learning
          else
            python -m a_top10 && python -m a_top10.steps.step7_self_learning
          fi

      # =====================================================
      # P1: Debug Report (machine + human) — ALWAYS run
      # - 每次 run 生成新文件（带 run_id）
      # - 同时覆盖 latest 固定入口（step_health.md / run_meta.json）
      # =====================================================
      - name: Generate Debug Reports (always)
        if: always()
        shell: bash
        env:
          TRADE_DATE: ${{ steps.resolve_date.outputs.trade_date }}
        run: |
          set -euo pipefail

          mkdir -p outputs/debug

          RUN_ID="${{ github.run_id }}"
          RUN_NUM="${{ github.run_number }}"
          SHA="${{ github.sha }}"
          REF="${{ github.ref }}"
          WF="${{ github.workflow }}"
          JOB="${{ github.job }}"
          ACTOR="${{ github.actor }}"
          EVENT="${{ github.event_name }}"
          REPO="${{ github.repository }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # ---- machine readable: run_meta_<run_id>.json + run_meta.json(latest) ----
          python - << 'PY'
          import json, os, pathlib, datetime, platform

          out_dir = pathlib.Path("outputs/debug")
          out_dir.mkdir(parents=True, exist_ok=True)

          run_id = os.environ.get("RUN_ID","")
          meta = {
            "schema": "a-top10.debug.run_meta.v1",
            "trade_date": os.environ.get("TRADE_DATE",""),
            "run_id": run_id,
            "run_number": os.environ.get("RUN_NUM",""),
            "repo": os.environ.get("REPO",""),
            "workflow": os.environ.get("WF",""),
            "job": os.environ.get("JOB",""),
            "ref": os.environ.get("REF",""),
            "sha": os.environ.get("SHA",""),
            "actor": os.environ.get("ACTOR",""),
            "event": os.environ.get("EVENT",""),
            "run_url": os.environ.get("RUN_URL",""),
            "utc_time": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
            "python": platform.python_version(),
            "platform": platform.platform(),
          }

          p_unique = out_dir / f"run_meta_{run_id}.json"
          p_latest = out_dir / "run_meta.json"
          p_unique.write_text(json.dumps(meta, ensure_ascii=False, indent=2), encoding="utf-8")
          p_latest.write_text(json.dumps(meta, ensure_ascii=False, indent=2), encoding="utf-8")
          print("Wrote:", p_unique, p_latest)
          PY
          # 传 env 给上面的 python
        env:
          RUN_ID: ${{ github.run_id }}
          RUN_NUM: ${{ github.run_number }}
          SHA: ${{ github.sha }}
          REF: ${{ github.ref }}
          WF: ${{ github.workflow }}
          JOB: ${{ github.job }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
          REPO: ${{ github.repository }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Generate Step Health (always)
        if: always()
        shell: bash
        env:
          TRADE_DATE: ${{ steps.resolve_date.outputs.trade_date }}
        run: |
          set -euo pipefail

          mkdir -p outputs/debug

          RUN_ID="${{ github.run_id }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TD="${TRADE_DATE}"
          YEAR="${TD:0:4}"
          SNAP_DIR="${WAREHOUSE_ROOT}/${DATA_REPO}/${RAW_DIR}/${YEAR}/${TD}"

          HEALTH_UNIQ="outputs/debug/step_health_${RUN_ID}.md"
          HEALTH_LATEST="outputs/debug/step_health.md"

          {
            echo "# Step Health Report"
            echo ""
            echo "- trade_date: **${TD}**"
            echo "- run_id: **${RUN_ID}**"
            echo "- run_url: ${RUN_URL}"
            echo "- sha: **${{ github.sha }}**"
            echo "- ref: **${{ github.ref }}**"
            echo ""
            echo "## 1) 数据仓库快照（warehouse）"
            echo ""
            echo "- snapshot_dir: \`${SNAP_DIR}\`"
            if [ -d "$SNAP_DIR" ]; then
              echo "- snapshot_dir_exists: ✅"
              echo ""
              echo "### snapshot files"
              echo ""
              echo '```text'
              ls -la "$SNAP_DIR" || true
              echo '```'
            else
              echo "- snapshot_dir_exists: ❌"
              echo ""
            fi

            echo "## 2) 输出目录（outputs）"
            echo ""
            echo "### outputs tree (top)"
            echo ""
            echo '```text'
            ls -la outputs || true
            echo '```'
            echo ""

            echo "## 3) 关键产物检查"
            echo ""
            for f in \
              "outputs/predict_top10_${TD}.md" \
              "outputs/predict_top10_${TD}.json" \
              "outputs/latest.md" \
              "outputs/debug_step4_theme_${TD}.json"
            do
              if [ -f "$f" ]; then
                echo "- ✅ exists: \`$f\` (size=$(wc -c <"$f" 2>/dev/null || echo 0))"
              else
                echo "- ❌ missing: \`$f\`"
              fi
            done
            echo ""

            echo "## 4) Step7 自学习（learning）目录"
            echo ""
            if [ -d "outputs/learning" ]; then
              echo "- outputs/learning: ✅"
              echo ""
              echo '```text'
              ls -la outputs/learning || true
              echo '```'
            else
              echo "- outputs/learning: ❌"
            fi
            echo ""

            echo "## 5) 结论（你应该先看这一段）"
            echo ""
            if [ ! -d "$SNAP_DIR" ]; then
              echo "- 当前 run 失败/异常的首要可能：**快照目录不存在或未下载成功**"
              echo "- 建议：先看 Actions 日志里 Download step 的 curl 是否 404/403"
            else
              echo "- 快照目录存在：✅"
              echo "- 若仍失败：优先看 **Run Top10 Engine** step 的 traceback"
            fi
          } > "$HEALTH_UNIQ"

          cp -f "$HEALTH_UNIQ" "$HEALTH_LATEST"

          echo "Wrote:"
          ls -lh "$HEALTH_UNIQ" "$HEALTH_LATEST"

      - name: Commit & push outputs (always)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          git status --porcelain

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A

          # commit message 带 trade_date + run_id，方便追溯
          td="${{ steps.resolve_date.outputs.trade_date }}"
          rid="${{ github.run_id }}"
          git commit -m "auto: run top10 ${td} (run=${rid})" || true

          # 不让 rebase/push 失败导致整个 job 失败（debug 产物已生成）
          git pull --rebase origin main || true
          git push || true
