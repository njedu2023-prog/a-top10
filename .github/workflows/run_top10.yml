name: Run Top10 Engine (Auto Daily)

on:
  schedule:
    - cron: "30 1 * * *" # UTC 01:30 = Asia/Shanghai 09:30
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: top10-daily
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Shanghai
      PYTHONUTF8: "1"

      # ✅ 关键：secret 名为 A_TOP10_TOKEN，这里桥接到程序读取的 TUSHARE_TOKEN
      TUSHARE_TOKEN: ${{ secrets.A_TOP10_TOKEN }}

      # ---- 数据仓库信息（方案二：只用 raw，不用 GitHub API）----
      DATA_GITHUB_USER: njedu2023-prog
      DATA_REPO: a-share-top3-data
      DATA_BRANCH: main

      # ---- 与 configs/default.yml 对齐（warehouse_root / repo_name / raw_dir）----
      WAREHOUSE_ROOT: _warehouse
      RAW_DIR: data/raw

      # ---- 需要下载的文件清单（按 data/raw/YYYY/YYYYMMDD/ 内实际文件名）----
      FILES: "daily.csv daily_basic.csv limit_list_d.csv hot_boards.csv top_list.csv"

      # ---- 自动回溯天数（找最近一个有数据的交易日目录）----
      LOOKBACK_DAYS: "20"

      # ---- 用于探测数据是否存在的哨兵文件 ----
      PROBE_FILE: "daily.csv"

    steps:
      - name: Checkout engine repo (a-top10)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # ✅ pandas.DataFrame.to_markdown 依赖 tabulate
          pip install -U tabulate

      - name: Resolve latest snapshot trade_date (auto) - scheme2(raw probe)
        id: resolve_date
        shell: bash
        run: |
          set -euo pipefail

          echo "TZ=$TZ"
          echo "DATA_GITHUB_USER=$DATA_GITHUB_USER"
          echo "DATA_REPO=$DATA_REPO"
          echo "DATA_BRANCH=$DATA_BRANCH"
          echo "LOOKBACK_DAYS=$LOOKBACK_DAYS"
          echo "PROBE_FILE=$PROBE_FILE"

          today="$(date +%Y%m%d)"
          echo "today=$today"

          base="https://raw.githubusercontent.com/${DATA_GITHUB_USER}/${DATA_REPO}/${DATA_BRANCH}/${RAW_DIR}"

          found=""
          for i in $(seq 0 "$LOOKBACK_DAYS"); do
            d="$(date -d "${today} -${i} day" +%Y%m%d)"
            y="${d:0:4}"
            url="${base}/${y}/${d}/${PROBE_FILE}"

            code="$(curl -s -o /dev/null -w "%{http_code}" -I "$url" || true)"
            echo "[probe] ${d} => ${code} ${url}"

            if [ "$code" = "200" ]; then
              found="$d"
              break
            fi
          done

          if [ -z "$found" ]; then
            echo "ERROR: cannot find any snapshot within last ${LOOKBACK_DAYS} days."
            exit 2
          fi

          echo "Resolved trade_date=$found"
          echo "trade_date=$found" >> "$GITHUB_OUTPUT"

      - name: Download snapshot files to warehouse (raw)
        id: download
        shell: bash
        run: |
          set -euo pipefail

          trade_date="${{ steps.resolve_date.outputs.trade_date }}"
          year="${trade_date:0:4}"

          dest="${WAREHOUSE_ROOT}/${DATA_REPO}/${RAW_DIR}/${year}/${trade_date}"
          mkdir -p "$dest"

          base="https://raw.githubusercontent.com/${DATA_GITHUB_USER}/${DATA_REPO}/${DATA_BRANCH}/${RAW_DIR}/${year}/${trade_date}"

          echo "Downloading to: $dest"
          echo "Base URL: $base"
          echo "Files: $FILES"

          for f in $FILES; do
            url="${base}/${f}"
            out="${dest}/${f}"

            echo "[get] $url"
            curl -fL --retry 3 --retry-delay 1 -o "$out" "$url"
            ls -lh "$out"
          done

          echo "OK: downloaded snapshots for ${trade_date}"

      - name: Debug warehouse (list)
        shell: bash
        run: |
          set -euo pipefail
          echo "====== LIST _warehouse (top) ======"
          ls -la _warehouse || true
          echo "====== LIST snapshot dir ======"
          trade_date="${{ steps.resolve_date.outputs.trade_date }}"
          year="${trade_date:0:4}"
          ls -la "${WAREHOUSE_ROOT}/${DATA_REPO}/${RAW_DIR}/${year}/${trade_date}" || true

      - name: Run Top10 Engine
        shell: bash
        env:
          TRADE_DATE: ${{ steps.resolve_date.outputs.trade_date }}
        run: |
          set -euo pipefail
          echo "Running engine with TRADE_DATE=$TRADE_DATE"
          if [ -f "run.py" ]; then
            python run.py
          else
            python -m a_top10
          fi

      - name: Commit & push outputs (if changed)
        shell: bash
        run: |
          set -euo pipefail

          git status --porcelain

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "auto: run top10 ${{ steps.resolve_date.outputs.trade_date }}"
          git pull --rebase origin main && git push
